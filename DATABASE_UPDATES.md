# Обновления базы данных для Legalia

## Обязательные SQL-скрипты для выполнения

Выполните следующие SQL-скрипты в указанном порядке через панель Supabase:

### 1. Исправление данных университетов
```bash
# Файл: fix_university_data.sql
```
- Удаляет "Alta Universitate" 
- Переименовывает университеты
- Устанавливает правильные логотипы

### 2. Обновление leaderboard университетов  
```bash
# Файл: final_university_leaderboard.sql
```
- Обновляет логику XP на фиксированные 15 XP за успешное прохождение
- Исключает "Alta Universitate"
- Создает views для лидерборда университетов

### 3. Создание leaderboard пользователей
```bash
# Файл: user_leaderboard_views.sql
```
- Создает views для лидерборда пользователей
- Использует фиксированные 15 XP за успешное прохождение
- Ограничивает топ-100
- **ИСПРАВЛЕНО**: Использует email как никнейм (fallback)

## Изменения в логике XP

**Старая система:**
- 10 базовых очков + процентный результат (10-110 очков за квиз)

**Новая система:**
- Фиксированные 15 XP за каждый успешно пройденный квиз (≥70%)
- 0 XP за неуспешный квиз (<70%)

## Проверка результатов

После выполнения SQL-скриптов:

1. Проверьте, что "Alta Universitate" больше не отображается
2. Убедитесь, что все университеты имеют правильные логотипы
3. Проверьте, что XP рассчитывается правильно (по 15 за каждый completed quiz)
4. Убедитесь, что лидерборд показывает корректные данные

## Важные изменения в приложении

1. **Удалена секция "Săptămâna aceasta"** - остались только:
   - Utilizatori (топ-100)
   - Universități (all-time)

2. **Логика XP**: Фиксированные 15 XP за успешное прохождение (≥70%)

3. **Логика стриков**: Дни подряд, сброс при пропуске дня

4. **Обработка ошибок**: Все сообщения на румынском языке

5. **Навигация**: Онбординг → Регистрация → Основное приложение (табы)

## Решение проблем

### Ошибка: "column up.user_name does not exist"
**Решение**: Обновленный файл `user_leaderboard_views.sql` использует `auth.users.email` как никнейм вместо несуществующего поля `user_name`.

### Ошибка: "university_id does not exist"
**Решение**: Если поле `university_id` отсутствует в таблице `home_userprofile`, может потребоваться выполнить дополнительную миграцию для добавления этого поля или использовать альтернативную логику связи пользователей с университетами.